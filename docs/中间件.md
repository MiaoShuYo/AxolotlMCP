# 中间件（Middleware）

## 目标
- 在请求进入处理器前后插入横切逻辑（日志、鉴权、限流、审计、埋点等）。

## 核心类型
- IRequestMiddleware：定义 InvokeAsync(request, ct, next)。
- RequestMiddlewarePipeline：按注册顺序构建 next 链，最终调用处理器。

## 注册与使用
- 在 DI 中注册一个或多个 IRequestMiddleware 实现即可自动组成管道：
```
services.AddSingleton<IRequestMiddleware, TimingMiddleware>();
services.AddSingleton<IRequestMiddleware>(_ => new RateLimitMiddleware(permitLimit: 32));
```
- 管道由 RequestMiddlewarePipeline 注入到 McpServer，请求会先经过管道再到处理器。

## 内置示例
- TimingMiddleware：记录执行耗时与结果。
- RateLimitMiddleware：并发限流（令牌桶）。
- ApiKeyAuthMiddleware：从 `params.headers` 中读取并校验 API Key（可选）。
- TimeoutMiddleware：单请求超时控制（可选）。
- ToolSandboxMiddleware：仅对 `tools/call` 生效，按工具名并发配额与超时。

## Tracing 约定
- 管道总体可在 mcp.request 之下扩展 mcp.middleware.* 子 span：
  - mcp.middleware.timing：middleware.name=timing, middleware.success, duration.ms。
  - mcp.middleware.ratelimit：middleware.name=ratelimit, middleware.success。

## 配置示例
```
{
  "Mcp": {
    "RateLimit": { "PermitLimit": 64, "QueueLimit": 256 },
    "Security": {
      "ApiKeyEnabled": true,
      "ApiKeyHeader": "x-api-key",
      "AllowedKeys": ["your-key"],
      "RequestTimeoutSeconds": 10
    },
    "ToolSandbox": {
      "DefaultTimeoutSeconds": 10,
      "DefaultMaxConcurrentPerTool": 8
    }
  }
}
```
