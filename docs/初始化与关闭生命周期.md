# 初始化与关闭生命周期

本文档说明 MCP 服务器在初始化（initialize）、关停（shutdown）与退出（exit）方面的协议适配与实现方式。

## 状态机概览

`initialize → (running) → shutdown → exit`

- `ServerLifecycle` 用原子标志维护 `IsInitialized`、`IsShuttingDown`、`ExitRequested`，并提供幂等的 `TryInitialize`、`TryShutdown`、`MarkExitRequested`。

## 处理流程

- `initialize`：默认处理器 `DefaultHandler` 返回 `protocolVersion/capabilities/serverInfo`。
- `shutdown`：默认处理器返回 `{ ok: true }`，实际停机由宿主的 `McpServerHostedService.StopAsync` 驱动。
- `exit`：默认处理器返回 `{ ok: true }`，用于兼容通知型退出指令。

## 宿主集成

- `ServerOptions.ShutdownWaitSeconds` 控制优雅关闭的超时时间。
- `McpServerHostedService` 连接 Host 生命周期，`StopAsync` 中使用超时令牌并调用 `McpServer.StopAsync`。

## 扩展建议

- 在路由处引入中间件，拦截 `initialize` 前的其它请求并以错误码拒绝。
- 在 `shutdown/exit` 到来时拒绝新请求，仅继续清空就绪队列。


