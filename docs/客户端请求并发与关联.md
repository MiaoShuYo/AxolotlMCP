# 客户端请求并发与关联

本文档详细说明客户端（`McpClient`）在请求-响应关联、并发控制、超时与重试方面的实现原理与使用方式。

## 功能概览

- 请求-响应关联：使用随机 `id` 建立 `_pending` 映射，读循环匹配响应并完成对应任务。
- 并发控制：可选的 `SemaphoreSlim`（`ClientOptions.MaxConcurrentRequests`>0 时启用）。
- 超时控制：`DefaultRequestTimeout`（或通过 `ClientOptions.DefaultRequestTimeoutSeconds` 设置）。
- 重试机制：针对超时等暂时性失败，使用指数退避（`MaxRetries`、`RetryBackoffBaseMs`）。

## 关键类型

- `ClientOptions`
  - `MaxConcurrentRequests`：并发上限（0 或更小表示不限制）。
  - `DefaultRequestTimeoutSeconds`：默认超时（秒）。
  - `MaxRetries`：最大重试次数（0 表示不重试）。
  - `RetryBackoffBaseMs`：指数退避基数（毫秒）。

## 使用方式

```csharp
var options = new ClientOptions
{
    MaxConcurrentRequests = 16,
    DefaultRequestTimeoutSeconds = 20,
    MaxRetries = 2,
    RetryBackoffBaseMs = 200
};

var client = new McpClient(new StdioTransport(), logger, options);
await client.ConnectAsync();

var response = await client.SendRequestAsync(new RequestMessage
{
    Method = "tools/list"
});
```

## 实现要点

1. `SendRequestAsync` 在启用并发限制时先 `WaitAsync`，结束后 `Release`。
2. 每次尝试都会生成新的请求 `id` 与 TCS，避免重复使用导致关联错误。
3. 超时通过 `CancellationTokenSource.CancelAfter` 与注册回调联动完成 TCS。
4. 指数退避等待：`baseMs * 2^(attempt-1)`，支持取消。

## 未来扩展

- 针对不同异常类型的重试策略分类（网络错误、服务器繁忙等）。
- 指标采集（请求时延、超时率、重试次数分布）。


