# 工具注册与调用机制

本文档说明 AxolotlMCP 的工具机制：如何定义工具、注册到运行时、通过 MCP 协议对外暴露（tools/list）并执行（tools/call）。

## 关键角色
- ITool（Core）: 工具抽象，定义名称、描述、输入参数 Schema 与执行方法。
- ToolRegistry（Core）: 工具注册中心，负责注册、查询与枚举工具。
- DefaultHandler（Server）: 默认处理器，实现 initialize、tools/list、tools/call 的请求路由与编排。

## 类型与职责
- ITool
  - Name: 工具唯一标识（区分大小写不敏感，由注册中心以 OrdinalIgnoreCase 存储）。
  - Description: 人类可读描述。
  - InputSchema: 输入参数 JSON Schema（用于约束/提示）。
  - ExecuteAsync(JsonElement arguments): 执行工具逻辑并返回 JSON 结果。
- ToolRegistry
  - Register(ITool): 单个工具注册（同名去重）。
  - RegisterRange(IEnumerable<ITool>): 批量注册。
  - TryGet(name, out tool): 按名称查询。
  - GetAll(): 列出所有已注册工具。
- DefaultHandler
  - initialize: 返回协议版本、能力宣告（tools）。
  - tools/list: 基于 ToolRegistry 输出工具清单（名称、描述、输入 Schema）。
  - tools/call: 解析 name、arguments，执行对应 ITool 并返回结果。

## 协议交互
### tools/list 请求
```json
{
  "jsonrpc": "2.0",
  "id": "1",
  "method": "tools/list",
  "params": {}
}
```
响应（示例）：
```json
{
  "jsonrpc": "2.0",
  "id": "1",
  "result": {
    "tools": [
      {
        "name": "echo",
        "description": "回显输入文本",
        "inputSchema": {
          "type": "object",
          "properties": {
            "text": { "type": "string", "description": "要回显的内容" }
          },
          "required": ["text"]
        }
      }
    ]
  }
}
```

### tools/call 请求
```json
{
  "jsonrpc": "2.0",
  "id": "2",
  "method": "tools/call",
  "params": {
    "name": "echo",
    "arguments": { "text": "hello" }
  }
}
```
响应（示例）：
```json
{
  "jsonrpc": "2.0",
  "id": "2",
  "result": {
    "content": [ { "type": "text", "text": "hello" } ]
  }
}
```

## 错误与异常
- 方法未找到: code = -32601（如未知 method 或未知工具名）。
- 无效参数: code = -32602（缺失 name/arguments 或类型不匹配）。
- 执行异常: 执行 ITool 时抛出异常，需记录日志并返回错误对象（建议规范化错误码）。

## 注册与使用建议
- 注册位置：应用启动时统一注册（例如在 DI 组装阶段）。
- 命名约定：Name 使用小写短名，避免空格与特殊字符。
- Schema 质量：尽量为每个参数提供 type/description/required，提升前后端协作体验。
- 并发与超时：工具内部应支持 CancellationToken，避免阻塞；必要时在 DefaultHandler 层加入超时编排。

## 扩展方向
- 特性驱动注册：使用特性标注工具类，由扫描器自动注册。
- DTO → Schema 生成：从 C# DTO 自动生成 JSON Schema，减少手写错误。
- 权限与审计：为敏感工具加鉴权与审计日志。
- 资源配额：对工具调用进行频率/并发限制与配额管理。

## 相关实现位置
- `src/AxolotlMCP.Core/Tools/ITool.cs`
- `src/AxolotlMCP.Core/Tools/ToolRegistry.cs`
- `src/AxolotlMCP.Server/DefaultHandler.cs`
